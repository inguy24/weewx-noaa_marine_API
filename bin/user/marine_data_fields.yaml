# WeeWX Marine Data Extension - Complete Field Definitions
# 100% Data-Driven YAML following install.py requirements
# Updated to support all installer functionality with no hardcoding

# PRIORITY 1: Module Configuration Mapping
# Added config mapping fields to support install.py configuration generation
api_modules:
  coops_module:
    display_name: "NOAA Tides & Currents (CO-OPS)"
    description: "Real-time water levels, tide predictions, and coastal water temperature from NOAA CO-OPS stations"
    api_url: "https://api.tidesandcurrents.noaa.gov/api/prod/datagetter"
    recommended_interval: 600  # 10 minutes for water level data
    service_name: "coops_tides"
    units_parameter: true
    api_type: "rest_json"
    
    # PRIORITY 1: Configuration mapping support
    config_module_name: "coops"
    config_interval_name: "coops_collection_interval"
    endpoint_config_name: "api_endpoints.coops"
    
    # API products supported by this module
    api_products:
      water_level:
        product_code: "water_level"
        update_frequency: 600  # 10 minutes
        description: "Real-time observed water levels"
      predictions:
        product_code: "predictions"
        update_frequency: 21600  # 6 hours
        description: "Tide predictions based on harmonic analysis"
      water_temperature:
        product_code: "water_temperature"
        update_frequency: 600  # 10 minutes
        description: "Coastal water temperature (limited station availability)"
    
  ndbc_module:
    display_name: "NOAA National Data Buoy Center (NDBC)"
    description: "Real-time marine weather and oceanographic data from NDBC buoy stations"
    api_url: "https://www.ndbc.noaa.gov/data/realtime2"
    recommended_interval: 3600  # 1 hour for buoy data
    service_name: "ndbc_weather"
    units_parameter: false
    api_type: "text_file"
    
    # PRIORITY 1: Configuration mapping support
    config_module_name: "ndbc"
    config_interval_name: "ndbc_weather_interval"
    endpoint_config_name: "api_endpoints.ndbc"
    
    # File types supported by NDBC
    file_types:
      stdmet:
        file_extension: ".txt"
        update_frequency: 3600  # 60 minutes
        description: "Standard meteorological data (wind, waves, temperature, pressure)"
      ocean:
        file_extension: ".ocean"
        update_frequency: 3600  # 60 minutes
        description: "Ocean data (currents, salinity, conductivity)"
      spec:
        file_extension: ".spec"
        update_frequency: 3600  # 60 minutes
        description: "Spectral wave data"

# Complete field definitions organized by API module
fields:
  # CO-OPS Module Fields
  current_water_level:
    display_name: "Current water level"
    database_field: "marine_current_water_level"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "data[0].v"
    service_field: "current_water_level"
    complexity_levels: ["minimal", "all"]
    unit_group: "group_distance"
    api_module: "coops_module"
    api_product: "water_level"
    description: "Current observed water level relative to station datum"
    
  water_level_sigma:
    display_name: "Water level measurement accuracy"
    database_field: "marine_water_level_sigma"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "data[0].s"
    service_field: "water_level_sigma"
    complexity_levels: ["all"]
    unit_group: "group_distance"
    api_module: "coops_module"
    api_product: "water_level"
    description: "Measurement accuracy estimate (Â±)"
    
  water_level_flags:
    display_name: "Water level quality flags"
    database_field: "marine_water_level_flags"
    database_type: "TEXT"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "data[0].f"
    service_field: "water_level_flags"
    complexity_levels: ["all"]
    unit_group: "group_count"
    api_module: "coops_module"
    api_product: "water_level"
    description: "Data quality control flags"
    
  coastal_water_temp:
    display_name: "Coastal water temperature"
    database_field: "marine_coastal_water_temp"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "data[0].v"
    service_field: "coastal_water_temp"
    complexity_levels: ["minimal", "all"]
    unit_group: "group_temperature"
    api_module: "coops_module"
    api_product: "water_temperature"
    description: "Water temperature at coastal stations (limited availability)"
    
  # Tide predictions (could be stored in separate table if desired)
  next_high_time:
    display_name: "Next high tide time"
    database_field: "marine_next_high_time"
    database_type: "TEXT"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "predictions[0].t"  # Processed by service logic
    service_field: "next_high_time"
    complexity_levels: ["minimal", "all"]
    unit_group: "group_count"
    api_module: "coops_module"
    api_product: "predictions"
    description: "Timestamp of next predicted high tide"
    
  next_high_height:
    display_name: "Next high tide height"
    database_field: "marine_next_high_height"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "predictions[0].v"  # Processed by service logic
    service_field: "next_high_height"
    complexity_levels: ["minimal", "all"]
    unit_group: "group_distance"
    api_module: "coops_module"
    api_product: "predictions"
    description: "Height of next predicted high tide"
    
  next_low_time:
    display_name: "Next low tide time"
    database_field: "marine_next_low_time"
    database_type: "TEXT"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "predictions[1].t"  # Processed by service logic
    service_field: "next_low_time"
    complexity_levels: ["minimal", "all"]
    unit_group: "group_count"
    api_module: "coops_module"
    api_product: "predictions"
    description: "Timestamp of next predicted low tide"
    
  next_low_height:
    display_name: "Next low tide height"
    database_field: "marine_next_low_height"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "predictions[1].v"  # Processed by service logic
    service_field: "next_low_height"
    complexity_levels: ["minimal", "all"]
    unit_group: "group_distance"
    api_module: "coops_module"
    api_product: "predictions"
    description: "Height of next predicted low tide"
    
  # NDBC Module Fields
  wave_height:
    display_name: "Significant wave height"
    database_field: "marine_wave_height"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "WVHT"
    service_field: "wave_height"
    complexity_levels: ["minimal", "all"]
    unit_group: "group_distance"
    api_module: "ndbc_module"
    file_type: "stdmet"
    description: "Significant wave height (average of highest 1/3 of waves)"
    
  wave_period:
    display_name: "Dominant wave period"
    database_field: "marine_wave_period"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "DPD"
    service_field: "wave_period"
    complexity_levels: ["minimal", "all"]
    unit_group: "group_time"
    api_module: "ndbc_module"
    file_type: "stdmet"
    description: "Dominant wave period in seconds"
    
  average_wave_period:
    display_name: "Average wave period"
    database_field: "marine_avg_wave_period"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "APD"
    service_field: "average_wave_period"
    complexity_levels: ["all"]
    unit_group: "group_time"
    api_module: "ndbc_module"
    file_type: "stdmet"
    description: "Average wave period in seconds"
    
  wave_direction:
    display_name: "Mean wave direction"
    database_field: "marine_wave_direction"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "MWD"
    service_field: "wave_direction"
    complexity_levels: ["all"]
    unit_group: "group_direction"
    api_module: "ndbc_module"
    file_type: "stdmet"
    description: "Mean wave direction in degrees (coming from)"
    
  sea_surface_temp:
    display_name: "Sea surface temperature"
    database_field: "marine_sea_surface_temp"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "WTMP"
    service_field: "sea_surface_temp"
    complexity_levels: ["minimal", "all"]
    unit_group: "group_temperature"
    api_module: "ndbc_module"
    file_type: "stdmet"
    description: "Sea surface temperature in Celsius"
    
  wind_speed:
    display_name: "Marine wind speed"
    database_field: "marine_wind_speed"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "WSPD"
    service_field: "wind_speed"
    complexity_levels: ["minimal", "all"]
    unit_group: "group_speed"
    api_module: "ndbc_module"
    file_type: "stdmet"
    description: "Wind speed at buoy location"
    unit_conversion: "wind_speed_m_s_to_weewx"
    
  wind_direction:
    display_name: "Marine wind direction"
    database_field: "marine_wind_direction"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "WDIR"
    service_field: "wind_direction"
    complexity_levels: ["minimal", "all"]
    unit_group: "group_direction"
    api_module: "ndbc_module"
    file_type: "stdmet"
    description: "Wind direction in degrees (coming from)"
    
  wind_gust:
    display_name: "Marine wind gust"
    database_field: "marine_wind_gust"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "GST"
    service_field: "wind_gust"
    complexity_levels: ["all"]
    unit_group: "group_speed"
    api_module: "ndbc_module"
    file_type: "stdmet"
    description: "Wind gust speed"
    unit_conversion: "wind_speed_m_s_to_weewx"
    
  barometric_pressure:
    display_name: "Marine barometric pressure"
    database_field: "marine_barometric_pressure"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "PRES"
    service_field: "barometric_pressure"
    complexity_levels: ["minimal", "all"]
    unit_group: "group_pressure"
    api_module: "ndbc_module"
    file_type: "stdmet"
    description: "Barometric pressure at sea level"
    
  air_temperature:
    display_name: "Marine air temperature"
    database_field: "marine_air_temperature"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "ATMP"
    service_field: "air_temperature"
    complexity_levels: ["all"]
    unit_group: "group_temperature"
    api_module: "ndbc_module"
    file_type: "stdmet"
    description: "Air temperature at buoy location"
    
  dewpoint:
    display_name: "Marine dew point"
    database_field: "marine_dewpoint"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "DEWP"
    service_field: "dewpoint"
    complexity_levels: ["all"]
    unit_group: "group_temperature"
    api_module: "ndbc_module"
    file_type: "stdmet"
    description: "Dew point temperature"
    
  visibility:
    display_name: "Marine visibility"
    database_field: "marine_visibility"
    database_type: "REAL"
    database_table: "archive"  # PRIORITY 2: Database table specification
    api_path: "VIS"
    service_field: "visibility"
    complexity_levels: ["all"]
    unit_group: "group_distance"
    api_module: "ndbc_module"
    file_type: "stdmet"
    description: "Horizontal visibility in nautical miles"
    unit_conversion: "nautical_miles_to_distance"

# PRIORITY 6: Enhanced complexity level definitions with detailed info
complexity_levels:
  minimal:
    description: "Essential marine data for basic coastal monitoring"
    target_field_count: 8
    includes: "Current water level, next tides, wave height, sea surface temperature, marine winds, barometric pressure"
    recommended_for: "Basic marine monitoring, small boats, fishing"
    estimated_api_calls_per_day: 288  # CO-OPS every 10 min + NDBC hourly
    coverage: "Critical marine safety parameters"
    
  all:
    description: "Complete marine dataset with all available parameters"
    target_field_count: 18
    includes: "All minimal fields plus detailed wave analysis, marine meteorology, water quality"
    recommended_for: "Professional marine operations, research, comprehensive monitoring"
    estimated_api_calls_per_day: 432  # All endpoints with full frequency
    coverage: "Comprehensive marine and meteorological data"
    
  custom:
    description: "User-selected specific marine parameters"
    includes: "Interactive selection from all available fields organized by data source"
    recommended_for: "Specialized applications, specific monitoring requirements"
    coverage: "Varies based on user selection"

# PRIORITY 3: Collection interval mapping with centralized configuration
collection_intervals:
  # Default intervals by data type
  default_coops_interval: 600      # 10 minutes for water levels
  default_ndbc_interval: 3600      # 1 hour for buoy data
  tide_prediction_interval: 21600  # 6 hours for tide predictions
  
  # Mapping between modules and configuration names
  mapping:
    coops_module: "coops_collection_interval"
    ndbc_module: "ndbc_weather_interval"
    
  # Interval recommendations by field type
  field_intervals:
    water_level: 600     # 10 minutes
    predictions: 21600   # 6 hours
    weather: 3600        # 1 hour
    waves: 3600          # 1 hour

# PRIORITY 4: NDBC predefined stations with comprehensive list
station_discovery:
  coops:
    metadata_url: "https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations.json"
    station_info_url: "https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations/{station_id}.json"
    products_filter: "?type=tidepredictions"
    health_check_url: "https://api.tidesandcurrents.noaa.gov/api/prod/datagetter"
    health_check_params: "?product=water_level&station={station_id}&time_zone=gmt&format=json&range=1"
    
    # Sample predefined stations (installer will discover more)
    predefined_stations:
      "9410230":
        name: "La Jolla"
        state: "CA"
        lat: 32.8669
        lon: -117.2571
        products: ["water_level", "predictions", "water_temperature"]
      "9410580":
        name: "Newport Bay"
        state: "CA"
        lat: 33.6034
        lon: -117.8820
        products: ["water_level", "predictions"]
      "8724580":
        name: "Key West"
        state: "FL"
        lat: 24.5550
        lon: -81.8082
        products: ["water_level", "predictions", "water_temperature"]
    
  ndbc:
    stations_page: "https://www.ndbc.noaa.gov/to_station.shtml"
    station_data_pattern: "https://www.ndbc.noaa.gov/data/realtime2/{station_id}.txt"
    station_info_pattern: "https://www.ndbc.noaa.gov/station_page.php?station={station_id}"
    health_check_pattern: "https://www.ndbc.noaa.gov/data/realtime2/{station_id}.txt"
    
    # PRIORITY 4: Comprehensive predefined NDBC stations
    predefined_stations:
      "46087":
        name: "California Coastal"
        lat: 33.616
        lon: -118.817
        file_types: ["stdmet", "ocean"]
        description: "Southern California coastal buoy"
      "46025":
        name: "Santa Monica Bay"
        lat: 33.749
        lon: -119.053
        file_types: ["stdmet"]
        description: "Santa Monica Bay monitoring buoy"
      "46042":
        name: "Monterey Bay"
        lat: 36.785
        lon: -122.469
        file_types: ["stdmet", "ocean", "spec"]
        description: "Monterey Bay deep water buoy"
      "46012":
        name: "Half Moon Bay"
        lat: 37.361
        lon: -122.879
        file_types: ["stdmet", "ocean"]
        description: "Northern California coastal buoy"
      "41004":
        name: "Southeast Atlantic"
        lat: 32.501
        lon: -79.099
        file_types: ["stdmet", "ocean", "spec"]
        description: "Southeast US Atlantic Ocean buoy"
      "44013":
        name: "Boston Harbor"
        lat: 42.346
        lon: -70.651
        file_types: ["stdmet"]
        description: "Boston Harbor entrance buoy"
      "45005":
        name: "Western Lake Superior"
        lat: 46.964
        lon: -91.424
        file_types: ["stdmet"]
        description: "Great Lakes monitoring buoy"

# PRIORITY 5: API endpoint defaults for fallback configuration
default_api_endpoints:
  coops:
    base_url: "https://api.tidesandcurrents.noaa.gov/api/prod/datagetter"
    metadata_url: "https://api.tidesandcurrents.noaa.gov/mdapi/prod/webapi/stations.json?expand=details"
    timeout: 30
    retry_attempts: 3
    
  ndbc:
    base_url: "https://www.ndbc.noaa.gov/data/realtime2"
    metadata_url: "https://www.ndbc.noaa.gov/activestations.xml"
    timeout: 30
    retry_attempts: 3

# PRIORITY 7: Configuration section mappings for bidirectional conversion
config_mappings:
  # YAML module names to configuration section names
  yaml_to_config:
    coops_module: "coops"
    ndbc_module: "ndbc"
    
  # Configuration section names back to YAML module names
  config_to_yaml:
    coops: "coops_module"
    ndbc: "ndbc_module"
    
  # Field selection mapping
  field_selection_mapping:
    coops_module: "coops_module"
    ndbc_module: "ndbc_module"

# Unit conversion definitions for marine data
unit_conversions:
  wind_speed_m_s_to_weewx:
    description: "Convert NDBC wind speed (m/s) to WeeWX unit system"
    from_unit: "m/s"
    to_unit: "weewx_wind_unit"
    formula: "convert_to_weewx_wind(x)"
    applies_when:
      data_source: "ndbc"
      field_type: "wind_speed"
    
  nautical_miles_to_distance:
    description: "Convert nautical miles to WeeWX distance unit"
    from_unit: "nautical_miles"
    to_unit: "weewx_distance_unit"
    formula: "convert_to_weewx_distance(x * 1.15078)"  # nautical miles to statute miles
    applies_when:
      data_source: "ndbc"
      field_name: "visibility"

# Database schema definitions for separate tables (if needed)
database_schemas:
  coops_data:
    description: "High-frequency CO-OPS data (6-minute updates)"
    table_name: "coops_data"
    primary_key: ["dateTime", "station_id"]
    indexes:
      - ["dateTime"]
      - ["station_id"]
      - ["dateTime", "station_id"]
    
  marine_forecast_data:
    description: "Low-frequency marine data (hourly and 6-hourly updates)"
    table_name: "marine_forecast_data"
    primary_key: ["dateTime", "station_id", "data_type"]
    indexes:
      - ["dateTime"]
      - ["station_id"]
      - ["data_type"]
      - ["dateTime", "station_id"]

# Station health monitoring parameters
station_health:
  coops:
    max_data_age_hours: 4
    retry_interval_minutes: 30
    consecutive_failure_threshold: 5
    
  ndbc:
    max_data_age_hours: 3
    retry_interval_minutes: 60
    consecutive_failure_threshold: 3
    
  general:
    health_check_interval: 3600  # 1 hour
    maintenance_log_retention_days: 30
    backup_station_activation_threshold: 2  # failures before switching